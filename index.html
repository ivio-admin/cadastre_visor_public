<!doctype html>
<html lang="es">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Cerca a Cadastre</title>
<style>
  body{font-family:system-ui,Segoe UI,Arial;margin:16px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  input{padding:8px 10px;border:1px solid #ccc;border-radius:8px}
  input[type="text"]{flex:1;min-width:250px}
  button{padding:8px 12px;border:0;border-radius:8px;background:#1f6feb;color:#fff;cursor:pointer}
  #estado{margin-top:10px;color:#555;font-size:0.9em}
  #debug{margin-top:10px;font:12px/1.3 monospace;color:#666;white-space:pre-wrap}
</style>

<div class="row">
  <input id="refcat" pattern="[A-Za-z0-9]{10,25}" required>
  <button id="btnBuscar">Cerca</button>
</div>

<div id="estado">
<div style="margin-top:10px">
  <div>Aquest cercador centra el mapa a la parcel·la introduïda.</div>
  <div style="margin-top:5px">La referència cadastral ha de tenir el següent format:</div>
  <div style="margin-top:5px; margin-left:30px">⋙ Exemple de <b>parcel·la rústega</b>: 25059A01100049</div>
  <div style="margin-left:50px">• 25 = provincia</div>
  <div style="margin-left:50px">• 059 = municipi</div>
  <div style="margin-left:50px">• A = sector</div>
  <div style="margin-left:50px">• 011 = polígon</div>
  <div style="margin-left:50px">• 00049 = parcel·la</div>
  <div style="margin-top:5px; margin-left:30px">⋙ Exemple de <b>parcel·la urbana</b>: 3913502CG3131S</div>
  <div style="margin-left:50px">• 3913502 = parcel·la</div>
  <div style="margin-left:50px">• CG3131S = full del plànol</div>
  <div style="margin-top:5px">Les referències cadastrals poden incloure els 4 dígits de la subparcel·la (a les parcel·les rústegues) o de l'inmoble (a les parcel·les urbanes), i finalment 2 caràcters de control, però aquest cercador els ignorarà.</div>
  <div id="debug"></div>
</details>
</div>

<script>
(function(){
  const experienceBase = 'https://experience.arcgis.com/experience/daef8b7a5db54252b656d29d8de38604';
  const mapWidgetId = 'widget_6';
  const dataSourceId = 'dataSource_4';
  const level = -1;
  const rotation = 0;
  const layerVisibilityObj = {
    "widget_6-dataSource_4": {
      "widget_6-dataSource_4-199e6b01859-layer-29-199e6b0199b-layer-39": true
    }
  };

  const DPI = 96;
  const INCHES_PER_METER = 39.37;
  const TARGET_PIXELS = 800;
  const PADDING = 1.25;
  const MIN_SCALE = 400;
  const MAX_SCALE = 25000;

  const workerProxy  = 'https://cadastre.ivio-admin.workers.dev/?url=';
  const proxy = workerProxy;
  const wrap  = url => proxy + encodeURIComponent(url);

  const q = id => document.getElementById(id);
  const estado = q('estado'), debug = q('debug');
  const setEstado = t => estado.textContent = t || '';

  async function fetchText(url){
    const res = await fetch(wrap(url));
    if(!res.ok) throw new Error('HTTP '+res.status);
    return res.text();
  }

  // 1) Escull ReferencePoint (centre aproximat) per centrar el mapa
  function getReferencePoint(xml){
    let m = xml.match(/<[^>]*ReferencePoint[^>]*>[\s\S]*?<[^:>]*:?pos[^>]*>([^<]+)<\/[^:>]*:?pos>/i);
    if(m){
      const [x,y] = m[1].trim().split(/\s+/).map(Number);
      if(Number.isFinite(x)&&Number.isFinite(y)) return {x,y};
    }
    m = xml.match(/<[^>]*:?Point[^>]*>[\s\S]*?<[^:>]*:?pos[^>]*>([^<]+)<\/[^:>]*:?pos>/i);
    if(m){
      const [x,y] = m[1].trim().split(/\s+/).map(Number);
      if(Number.isFinite(x)&&Number.isFinite(y)) return {x,y};
    }
    // Si no hi ha punt, es centrarà amb el centroide del posList
    const coords = getAllCoords(xml);
    if(coords.length>0){
      let sx=0, sy=0;
      for(const [cx,cy] of coords){ sx+=cx; sy+=cy; }
      return {x:sx/coords.length, y:sy/coords.length};
    }
    return null;
  }

  // 2) Extreu tots els vèrtexs (amb EPSG:3857) de la primera geometria trobada
  function getAllCoords(xml){
    const m = xml.match(/<[^>]*:?posList[^>]*>([^<]+)<\/[^:>]*:?posList>/i);
    if(!m) return [];
    const nums = m[1].trim().split(/\s+/).map(Number).filter(Number.isFinite);
    const out = [];
    for(let i=0;i+1<nums.length;i+=2) out.push([nums[i], nums[i+1]]);
    return out;
  }

  // 3) Bounding box i dimensió característica (máx de ample/alt)
  function getGeometryStats(coords){
    let minX=Infinity, minY=Infinity, maxX=-Infinity, maxY=-Infinity;
    for(const [x,y] of coords){
      if(x<minX) minX=x; if(x>maxX) maxX=x;
      if(y<minY) minY=y; if(y>maxY) maxY=y;
    }
    const width = (maxX-minX);
    const height = (maxY-minY);
    const maxDim = Math.max(width, height);
    return {minX,minY,maxX,maxY,width,height,maxDim};
  }

  // 4) Converteix "tamany en metres" a escala (1:scale)
  //    scale = metersPerPixel * DPI * inchesPerMeter
  function dimensionToScale(dimMeters){
    const metersPerPixel = (dimMeters * PADDING) / TARGET_PIXELS;
    return metersPerPixel * DPI * INCHES_PER_METER;
  }

  function computeAdaptiveScale(xml){
    const coords = getAllCoords(xml);
    if(coords.length === 0) return 1000; // fallback
    const {maxDim} = getGeometryStats(coords);
    // Si la parcel·la és casi un punt (dades extranyes), fa servir fallback
    if(!Number.isFinite(maxDim) || maxDim <= 0) return 1000;

    let scale = dimensionToScale(maxDim);
    // límits per no passar-se
    scale = Math.max(MIN_SCALE, Math.min(MAX_SCALE, Math.round(scale)));
    return scale;
  }

  // 5) Construeix el hash amb escala variable
  function buildHash(x, y, scale){
    const centerVal = encodeURIComponent(`${x},${y},102100`);
    const viewpoint = {
      rotation,
      scale,
      targetGeometry: {
        spatialReference: { latestWkid: 3857, wkid: 102100 },
        x: x,
        y: y
      }
    };
    const viewpointEnc = encodeURIComponent(JSON.stringify(viewpoint));
    const layerVisEnc  = encodeURIComponent(JSON.stringify(layerVisibilityObj));

    const parts = [
      `${mapWidgetId}=active_datasource_id:${dataSourceId}`,
      `center:${centerVal}`,
      `scale:${scale}`,
      `level:${level}`,
      `rotation:${rotation}`,
      `viewpoint:${viewpointEnc}`,
      `layer_visibility:${layerVisEnc}`
    ];
    return parts.join(',');
  }

  // === FLUXE PRINCIPAL ===
  async function buscar(){
    const rc = (q('refcat').value||'').trim();
    if(!rc){ setEstado('Introdueix una referència cadastral.'); return; }

    setEstado('Consultant referència cadastral...');
    if(q('debug')) q('debug').textContent = '';

    // GetParcel per REFCAT (EPSG:3857)
    const wfs = `https://ovc.catastro.meh.es/INSPIRE/wfsCP.aspx?service=wfs&version=2&request=getfeature&STOREDQUERIE_ID=GetParcel&srsname=EPSG:3857&REFCAT=${encodeURIComponent(rc)}`;

    try{
      const xml = await fetchText(wfs);
      if(q('debug')) q('debug').textContent = xml.substring(0,8000);

      const pt = getReferencePoint(xml);
      if(!pt){ setEstado('No s’ha trobat la referència cadastral.'); return; }

      // Escala adaptativa en funció de la dimensió de la parcel·la
      const adaptiveScale = computeAdaptiveScale(xml);

      const {x,y} = pt;
      const hash = buildHash(x, y, adaptiveScale);
      const sep  = experienceBase.includes('#') ? '&' : '#';
      const url  = `${experienceBase}${sep}${hash}`;

      setEstado(`Obrint el visor (escala 1:${adaptiveScale})...`);
      window.location.href = url;

    }catch(e){
      console.error(e);
      setEstado('Error del CORS/proxy o el servei WFS.');
    }
  }

  document.getElementById('btnBuscar').addEventListener('click', buscar);
  document.getElementById('refcat').addEventListener('keydown', e=>{ if(e.key==='Enter') buscar(); });
})();
</script>
</html>
